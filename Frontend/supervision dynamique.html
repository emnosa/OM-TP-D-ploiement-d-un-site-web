<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supervision et Configuration</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="bg-primary text-white text-center py-4">
    <h1>Application de Supervision</h1>
    <p>Configuration et supervision des données en temps réel</p>
  </header>

  <div class="container my-5">
    <!-- Formulaire de configuration -->
    <div class="section">
      <h2>Configuration des paramètres</h2>
      <form id="configForm">
        <div class="mb-3">
          <label for="variableName" class="form-label">Nom de la variable</label>
          <input type="text" class="form-control" id="variableName" placeholder="Exemple : Température">
        </div>
        <div class="mb-3">
          <label for="ipAddress" class="form-label">Adresse IP de l'automate</label>
          <input type="text" class="form-control" id="ipAddress" placeholder="Exemple : 192.168.0.10">
        </div>
        <div class="mb-3">
          <label for="variableToRead" class="form-label">Variable à lire</label>
          <input type="text" class="form-control" id="variableToRead" placeholder="Exemple : sensor_1">
        </div>
        <div class="mb-3">
          <label for="frequency" class="form-label">Fréquence de mise à jour (en secondes)</label>
          <input type="number" class="form-control" id="frequency" placeholder="Exemple : 5">
        </div>
        <button type="button" class="btn btn-primary" onclick="saveConfiguration()">Sauvegarder et démarrer</button>
      </form>
    </div>

    <!-- Liste de sélection des variables -->
    <div class="section mt-5">
      <h2>Sélectionner une variable à visualiser</h2>
      <select class="form-select" id="variableSelector" onchange="updateChart()">
        <option value="">Sélectionner une variable...</option>
      </select>
    </div>

    <!-- Historique des configurations -->
    <div class="section mt-5">
      <h2>Historique des configurations</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>#</th>
            <th>Nom de la variable</th>
            <th>Adresse IP</th>
            <th>Variable à lire</th>
            <th>Fréquence (s)</th>
          </tr>
        </thead>
        <tbody id="configHistory">
          <!-- Les configurations sauvegardées seront affichées ici -->
        </tbody>
      </table>
    </div>

    <!-- Graphique en temps réel -->
    <div class="section mt-5">
      <h2>Supervision en temps réel</h2>
      <canvas id="realtimeChart" width="300" height="300"></canvas> <!-- Taille réduite -->
    </div>
  </div>

  <script>
    let counter = 1; // Compteur pour l'historique
    let chart; // Graphique
    let intervalId; // ID de l'intervalle pour les mises à jour

    const configurations = []; // Tableau pour stocker les configurations de variables
    const simulatedData = {}; // Stocke les données simulées pour chaque variable
    const simulatedLabels = {}; // Stocke les timestamps pour chaque variable

    // Initialisation du graphique
    function initializeChart() {
      const ctx = document.getElementById('realtimeChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [], // X-axis
          datasets: [{
            label: 'Valeurs simulées',
            data: [], // Y-axis
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderWidth: 2,
            tension: 0,
            fill: false,
            stepped: true
          }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: 'Temps' } },
            y: { title: { display: true, text: 'Valeurs' }, min: -0.2, max: 1.2, ticks: { stepSize: 0.2 } }
          }
        }
      });
    }

    // Fonction pour sauvegarder la configuration
    function saveConfiguration() {
      const variableName = document.getElementById('variableName').value;
      const ipAddress = document.getElementById('ipAddress').value;
      const variableToRead = document.getElementById('variableToRead').value;
      const frequency = parseInt(document.getElementById('frequency').value);

      if (!variableName || !ipAddress || !variableToRead || isNaN(frequency) || frequency <= 0) {
        alert("Veuillez remplir tous les champs correctement !");
        return;
      }

      // Ajouter la configuration à la liste
      configurations.push({ variableName, ipAddress, variableToRead, frequency });
      const tableBody = document.getElementById('configHistory');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${counter++}</td>
        <td>${variableName}</td>
        <td>${ipAddress}</td>
        <td>${variableToRead}</td>
        <td>${frequency}</td>
      `;
      tableBody.appendChild(row);

      // Ajouter la variable à la liste déroulante
      const variableSelector = document.getElementById('variableSelector');
      const option = document.createElement('option');
      option.value = variableToRead;
      option.textContent = variableName;
      variableSelector.appendChild(option);

      // Démarrer la simulation pour cette variable
      startSimulation(variableToRead, frequency);
      document.getElementById('configForm').reset();
    }

    // Fonction pour simuler des données pour chaque variable
    function startSimulation(variable, frequency) {
      if (!simulatedData[variable]) {
        simulatedData[variable] = [];
        simulatedLabels[variable] = [];
      }

      intervalId = setInterval(() => {
        const now = new Date().toLocaleTimeString();
        const randomValue = Math.floor(Math.random() * 2); // 0 ou 1
        simulatedLabels[variable].push(now);
        simulatedData[variable].push(randomValue);

        if (simulatedLabels[variable].length > 10) {
          simulatedLabels[variable].shift();
          simulatedData[variable].shift();
        }

        // Si cette variable est sélectionnée, mettre à jour le graphique
        if (document.getElementById('variableSelector').value === variable) {
          chart.data.labels = simulatedLabels[variable];
          chart.data.datasets[0].data = simulatedData[variable];
          chart.update();
        }
      }, frequency * 1000); // Mises à jour toutes les X secondes
    }

    // Met à jour le graphique en fonction de la variable sélectionnée
    function updateChart() {
      const selectedVariable = document.getElementById('variableSelector').value;
      if (selectedVariable && simulatedData[selectedVariable]) {
        chart.data.labels = simulatedLabels[selectedVariable];
        chart.data.datasets[0].data = simulatedData[selectedVariable];
        chart.update();
      }
    }

    // Initialiser le graphique au chargement de la page
    initializeChart();
  </script>
</body>
</html>
